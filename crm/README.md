# CRM System Setup Guide

This guide will help you set up the CRM system with Celery for background tasks and Redis as the message broker.

## Prerequisites

- Python 3.8+
- pip (Python package manager)
- Redis server

## Installation Steps

### 1. Install Redis

**Ubuntu/Debian:**

```bash
sudo apt update
sudo apt install redis-server
sudo systemctl start redis
sudo systemctl enable redis
```

**macOS (using Homebrew):**

```bash
brew install redis
brew services start redis
```

**Windows:**
Download and install Redis from [https://redis.io/docs/latest/operate/oss_and_stack/install/install-redis/install-redis-on-windows/](https://redis.io/docs/latest/operate/oss_and_stack/install/install-redis/install-redis-on-windows/)

### 2. Install Python Dependencies

```bash
# Navigate to your project directory
cd /alx-backend-graphql_crm

# Install required packages
pip install django celery redis requests

# Or if you have a requirements.txt file
pip install -r requirements.txt
```

### 3. Configure Django Settings

Ensure your `crm/settings.py` includes the following Celery configuration:

```python
# Celery Configuration
CELERY_BROKER_URL = 'redis://localhost:6379/0'
CELERY_RESULT_BACKEND = 'redis://localhost:6379/0'
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = 'UTC'
```

### 4. Run Database Migrations

```bash
python manage.py migrate
```

### 5. Start Celery Worker

Open a new terminal window and run:

```bash
celery -A crm worker -l info
```

This starts the Celery worker that will process background tasks.

### 6. Start Celery Beat (for Periodic Tasks)

Open another terminal window and run:

```bash
celery -A crm beat -l info
```

This starts the Celery beat scheduler for periodic tasks.

## Verification Steps

### 1. Test Redis Connection

```bash
redis-cli ping
```

Should return `PONG` if Redis is running correctly.

### 2. Test Celery Task

Open a Django shell to test the CRM report task:

```bash
python manage.py shell
```

```python
from crm.tasks import generate_crm_report

# Test the task
result = generate_crm_report.delay()
print(f"Task ID: {result.id}")
```

### 3. Check Logs

Verify that reports are being generated by checking the log file:

```bash
tail -f /tmp/crm_report_log.txt
```

You should see entries like:

```bash
2024-01-15 14:30:00 - Report: 150 customers, 450 orders, 12500.75 revenue
```

### 4. Monitor Celery

Check if Celery workers are processing tasks by monitoring the worker terminal output.

## Common Issues

### Redis Connection Error

- Ensure Redis server is running: `redis-cli ping`
- Check if port 6379 is available

### Celery Worker Not Starting

- Verify Django project structure has proper `celery.py` and `__init__.py` files
- Check if all dependencies are installed

### No Logs Generated

- Verify file permissions in `/tmp/` directory
- Check if GraphQL endpoint is accessible at `http://localhost:8000/graphql`

## Scheduled Tasks

The system includes the following scheduled tasks:

- **CRM Report Generation**: Configured via Celery Beat (adjust schedule in `crm/celery.py`)
- **Order Reminders**: Daily at 8:00 AM (via cron)
- **Inactive Customer Cleanup**: Weekly on Sunday at 2:00 AM (via cron)

## Stopping Services

To stop all services:

```bash
# Stop Celery worker (Ctrl+C in the terminal)
# Stop Celery beat (Ctrl+C in the terminal)
# Stop Redis (if needed)
sudo systemctl stop redis  # Ubuntu/Debian
brew services stop redis   # macOS
```

## Troubleshooting

### Check Celery Status

```bash
celery -A crm status
```

### View Active Tasks

```bash
celery -A crm inspect active
```

### Purge All Tasks

```bash
celery -A crm purge
```